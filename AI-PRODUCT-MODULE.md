# AI 产品分析模块详细设计文档

## 一、模块概述

AI 产品分析模块是 SeekMoney 系统的核心功能之一，负责从社交媒体数据中挖掘用户需求，并基于 AI 技术自动生成可行的产品方案。该模块采用前后端分离架构，通过异步任务机制实现复杂的数据处理流程，为用户提供高效、准确的产品建议服务。

### 1.1 核心功能定位

本模块的主要功能是从 TikTok、TikHub 等社交媒体平台采集用户评论和内容数据，利用 GLM 系列的嵌入模型进行语义分析，识别用户痛点和需求，最终由 GLM-4.7 思考模型生成完整的产品方案。整个流程涵盖数据采集、语义聚类、AI 分析和结果展示四个核心环节，每个环节都经过精心设计，以确保分析结果的准确性和实用性。模块的设计充分考虑了扩展性，支持多种数据源接入和不同语言的分析输出，能够满足全球化场景下的产品需求。

### 1.2 技术栈组成

AI 产品分析模块的技术栈由多个层次的组件构成，形成了完整的技术闭环。在前端层面，采用 Next.js 14 的 App Router 架构，结合 React 的函数式组件和 Hooks 机制实现用户界面交互，使用 SWR 库进行服务端状态的轮询和缓存管理。在后端层面，核心任务管理由自定义的 AIProductJobManager 类负责，该类管理任务的创建、执行和状态更新全过程。AI 分析能力依托智谱 AI 的 GLM 系列模型，包括用于语义向量化的 embedding-3 模型和用于深度分析的 GLM-4.7 思考模型。所有服务通过 RESTful API 进行通信，保证了系统各组件之间的松耦合和可维护性。

## 二、系统架构设计

### 2.1 整体架构概览

AI 产品分析模块采用经典的 Web 应用三层架构，包括表现层、业务逻辑层和数据访问层。表现层负责用户界面的渲染和交互处理，业务逻辑层处理核心的分析流程和任务管理，数据访问层则负责与外部 API 和数据源的交互。这种分层设计使得各层职责清晰，便于独立测试和维护。在技术实现上，前端页面通过 HTTP 请求与后端 API 进行通信，后端使用异步任务处理机制避免长时间阻塞，整个系统运行在 Node.js 环境下，利用 Next.js 的服务端渲染能力提升首屏加载性能。

系统架构的核心设计理念是「异步非阻塞」，即用户提交分析请求后立即获得任务 ID，随后通过轮询机制获取任务状态和结果。这种设计既保证了用户体验的流畅性，又确保了复杂分析任务能够得到充分计算。在实际部署中，可以根据负载情况动态调整任务处理的并发度，同时通过任务过期清理机制避免内存泄漏。此外，系统还实现了完善的任务状态管理，包括初始化、处理中、完成、失败四种状态，每种状态都有对应的进度描述和错误信息，便于用户了解任务执行情况。

### 2.2 组件依赖关系

AI 产品分析模块由多个组件构成，这些组件之间存在明确的依赖和调用关系。最上层的组件是前端页面 `AIProductPage`，它依赖 `AnalysisForm` 组件收集用户输入，依赖 `JobStatus` 组件展示任务进度，依赖 `AIProductCard` 组件展示分析结果，以及依赖 `AIProductDetailModal` 组件展示详细分析内容。在 API 层面，`AIProductPage` 发送请求到 `POST /api/analyze-ai-product` 接口获取任务 ID，然后通过 `GET /api/ai-product-jobs/{jobId}` 接口轮询任务状态。

后端组件的依赖关系相对简单但功能明确。`analyze-ai-product/route.ts` 接收前端请求并调用 `AIProductJobManager.createJob()` 方法创建任务，`ai-product-jobs/[jobId]/route.ts` 则封装了 `AIProductJobManager.getJob()` 方法供前端查询任务状态。核心的 `AIProductJobManager` 类管理所有分析任务的完整生命周期，包括调用 `DataSourceFactory` 创建数据源服务、调用 `AIProductService` 执行 AI 分析。在数据源层面，`DataSourceFactory` 根据配置动态创建对应的数据源服务，目前支持 TikHub、TikTok 等平台的统一访问接口。

## 三、核心组件详解

### 3.1 前端页面组件

前端页面组件是用户与系统交互的直接入口，承担着数据展示和用户操作处理的双重职责。`AIProductPage` 作为主页面组件，采用 React 的函数式组件和 Hooks 机制实现状态管理。组件内部维护了任务 ID、分析结果、加载状态、模态框状态等多个状态变量，通过 `useState` Hook 进行状态管理。任务状态的轮询则委托给 `useSWR` 库实现，该库提供了自动重试、缓存管理等特性，大大简化了服务端状态管理的复杂度。

`AIProductPage` 的核心交互逻辑围绕 `handleAnalysisSubmit` 函数展开。当用户提交分析请求时，该函数首先设置加载状态并清空之前的结果，然后构造请求参数发送到 `/api/analyze-ai-product` 接口。请求成功后，函数保存返回的任务 ID，后续的轮询机制会自动根据这个 ID 查询任务状态。当任务完成时，`useSWR` 的 `onSuccess` 回调会被触发，此时分析结果会被设置到 `results` 状态变量中，页面随后渲染 `AIProductCard` 组件展示分析内容。整个流程设计得简洁高效，既保证了用户体验，又确保了数据处理的完整性。

### 3.2 任务管理服务

任务管理服务是 AI 产品分析模块的核心引擎，由 `AIProductJobManager` 类实现。该类采用单例模式设计，确保在整个应用生命周期内只有一个任务管理器实例。类的核心职责包括创建新任务、执行任务、管理任务状态和清理过期任务。在内部实现上，`AIProductJobManager` 使用 `Map` 数据结构存储所有任务，键为任务 ID，值为任务对象。任务对象包含了任务的完整信息，包括状态、进度、关键词、数据源、区域设置、开始时间、结果和错误信息等字段。

`createJob` 方法是任务管理的入口点，负责创建新任务并启动异步执行流程。该方法首先生成唯一的任务 ID，构造任务对象并添加到任务 Map 中，然后异步调用 `executeJob` 方法开始执行。之所以采用异步执行方式，是因为 AI 产品分析涉及数据采集、语义处理、AI 生成等多个耗时步骤，如果采用同步方式会阻塞 API 响应，影响用户体验。`executeJob` 方法则封装了完整的任务执行逻辑，包括验证数据源、抓取数据、执行 AI 分析、更新任务状态等步骤。该方法使用 `try-catch` 块包裹整个执行流程，任何步骤出错都会将任务状态更新为 `failed` 并记录错误信息。

### 3.3 AI 分析服务

AI 分析服务由 `AIProductService` 类实现，是整个模块的智能核心。该类封装了与 GLM API 的所有交互逻辑，包括 API 密钥管理、请求构造、响应解析和错误处理。`AIProductService` 的构造函数从环境变量中读取 API 配置，包括 API 密钥、模型名称和基础 URL。这些配置通过 `.env` 文件或系统环境变量提供，便于在不同环境中灵活调整。默认情况下，服务使用 `glm-4-flash` 模型，该模型在保持较好分析能力的同时具有较低的响应延迟和成本。

`analyzeForAIProduct` 方法是 AI 分析服务的核心接口，接收文本数组和区域设置参数，返回结构化的产品分析结果。该方法首先验证 API 密钥是否配置，然后调用 `buildAIProductPrompt` 方法构造 AI 提示词。提示词的设计是获得高质量分析结果的关键，它明确告诉 AI 以产品经理的角色工作，基于输入的文本内容设计 AI 应用产品。提示词包含详细的输出格式要求，确保 AI 返回的结果符合预定义的数据结构。API 请求采用 axios 库发送超时控制为 60 秒的超时限制，避免长时间等待导致的资源浪费。

### 3.4 提示词工程设计

AI 产品分析的提示词经过精心设计，旨在引导 GLM 模型生成高质量、可执行的产品方案。提示词的主体部分是「你是一位资深的 AI 产品经理，精通人工智能技术和产品设计」，这个角色设定确保 AI 以专业产品经理的视角思考问题。提示词的主体内容包括待分析的文本内容，这些内容经过筛选只取前 20 条，既保证了信息量又控制了 token 消耗。提示词的要求部分明确定义了输出 JSON 的结构，包含产品名称、产品类别、目标用户、核心功能列表、AI 能力列表、价值主张、实现难度、市场潜力、技术栈和开发路线图等字段。

提示词工程的一个重要特性是多语言支持。根据 `locale` 参数，提示词末尾会附加语言指令，中文环境要求用中文输出，英文环境则要求用英文输出。JSON 的键名保持英文不变，以便程序解析，但值的内容会根据语言要求自动调整。这种设计使得系统能够灵活支持全球化场景，无需为不同语言开发独立的分析逻辑。提示词还强调了几个关键要求：返回严格 JSON 格式、产品设计要切实可行、核心功能要具体可实现、AI 能力要明确、技术栈要实用、开发路线要清晰分阶段。这些要求引导 AI 生成既有创意又可落地的产品方案。

## 四、完整执行流程

### 4.1 用户交互阶段

用户交互阶段是整个分析流程的起点，由 `AIProductPage` 组件主导完成。当用户访问 `/ai-product` 路由时，页面组件首先渲染基本界面结构，包括顶部导航栏、左侧输入控制区和右侧结果显示区。如果用户尚未提交分析请求，结果显示区会展示空状态占位符，提示用户输入关键词开始分析。这种设计符合渐进式披露原则，避免信息过载，同时引导用户完成必要的操作。

用户输入关键词后，可以选择数据源（TikTok 或 TikHub）和调整其他参数。`AnalysisForm` 组件封装了表单的完整交互逻辑，包括输入验证、参数收集和提交处理。当用户点击「开始分析」按钮时，`handleAnalysisSubmit` 函数被触发执行。该函数首先进行基本的参数验证，确保关键词非空且为数组类型。验证通过后，函数设置加载状态，构造请求体，然后调用 fetch API 发送 POST 请求到 `/api/analyze-ai-product` 接口。请求成功后，函数保存返回的任务 ID，并更新页面状态触发轮询机制。整个交互过程设计得简洁直观，错误情况也有相应的提示和容错处理。

### 4.2 任务创建阶段

任务创建阶段主要在后端的 API 路由中完成。`POST /api/analyze-ai-product` 接口接收前端请求，首先进行参数验证。验证逻辑包括检查关键词是否存在、是否为非空数组、格式是否有效等。如果验证失败，接口返回 400 状态码和错误信息；如果验证成功，接口继续验证数据源参数，确保只接受 TikTok 或 TikHub 这两个有效值。验证通过后，接口调用 `aiProductJobManager.createJob()` 方法创建任务，该方法返回新创建的任务 ID。

`createJob` 方法的执行过程首先使用 UUID 库生成唯一的任务 ID，然后构造包含完整任务信息的状态对象。该对象包括任务 ID、初始状态（processing）、初始进度描述（正在初始化）、用户输入的关键词、分析数量限制、选择的数据源、区域设置参数和任务开始时间。任务对象创建后被添加到 `jobs` Map 中存储。随后方法异步调用 `executeJob` 开始执行任务，但立即返回任务 ID 给调用方。这种设计确保了 API 请求能够快速响应，用户不需要等待整个分析流程完成。任务执行在后台进行，完成后通过状态更新通知前端。

### 4.3 任务执行阶段

任务执行阶段是整个流程中耗时最长的部分，由 `executeJob` 方法负责。该方法首先从任务 Map 中获取任务对象，如果任务不存在则直接返回。接下来方法创建数据源服务，通过 `DataSourceFactory.createDataSource()` 工厂方法根据配置创建对应的数据源实例。同时获取数据源的显示名称，用于进度更新和错误提示。如果数据源支持可用性检查，方法会先验证数据源是否可用，不可用的数据源会导致任务失败并抛出错误。

数据抓取是任务执行的核心步骤之一。方法遍历用户提供的所有关键词，对每个关键词调用数据源服务的 `searchAndFetch` 方法获取相关内容。获取的原始文本被收集到 `allRawTexts` 数组中，同时更新任务进度反映当前抓取的进度。如果所有关键词都没有获取到有效数据，任务会抛出错误并标记为失败状态。成功抓取数据后，方法调用 `AIProductService.analyzeForAIProduct()` 执行 AI 分析。分析过程使用 GLM 模型，根据原始文本生成结构化的产品建议。分析完成后，结果被封装为 `AIProductResult` 对象，包含产品分析内容、代表性文本样本等信息。最后方法更新任务状态为 `completed`，保存分析结果到任务对象中。

### 4.4 结果获取阶段

结果获取阶段由前端通过轮询机制完成。当用户提交分析请求后，`AIProductPage` 组件使用 `useSWR` Hook 配置轮询逻辑。`useSWR` 的第一个参数是请求 URL，包含任务 ID 信息；第二个参数是 fetcher 函数，定义如何获取数据；第三个参数是配置对象，包含轮询间隔、成功回调等选项。轮询间隔的设置采用动态策略，当任务状态为 `processing` 时每 2 秒轮询一次，否则停止轮询。这种策略既保证了用户能够及时获取进度更新，又避免了不必要的网络请求。

`useSWR` 的成功回调 `onSuccess` 负责处理任务完成的逻辑。当回调接收到数据时，首先检查任务状态。如果状态为 `completed` 且包含结果数据，回调将结果设置到组件状态中，同时关闭加载状态，触发页面重新渲染显示分析卡片。如果状态为 `failed`，回调同样关闭加载状态，但会在界面上显示错误信息。此外，`useSWR` 还配置了 `revalidateOnFocus: false` 选项，禁用焦点重验证行为，避免页面切换回来时触发不必要的请求。这种精细的配置确保了轮询行为符合业务需求，在提供实时更新体验的同时控制了资源消耗。

## 五、数据流转分析

### 5.1 输入数据结构

AI 产品分析模块的输入数据主要包含四个维度：关键词配置、数据源选择、分析参数和区域设置。关键词是分析的核心输入，决定了从社交媒体平台搜索什么内容。关键词可以是一个字符串数组，支持同时分析多个相关关键词，任务管理器会自动分配每个关键词的采集配额。数据源选择决定了从哪个平台获取数据，目前支持 TikHub（聚合平台）和 TikTok（独立平台）两个选项。分析参数包括每个关键词的采集数量限制，系统会根据关键词数量自动分配每条关键词的配额。区域设置影响 AI 分析结果的语言输出，支持中文和英文两种模式。

前端提交到 API 的请求体采用 JSON 格式，结构清晰简洁。请求体的字段包括 `keywords`（字符串数组）、`limit`（数值，默认为 50）、`dataSource`（字符串，默认为 'tiktok'）、`deepCrawl`（布尔值）、`maxVideos`（数值）和 `locale`（字符串，默认为 'zh'）。API 路由会对请求体进行严格的参数验证，过滤无效的关键词，修正不支持的数据源值，确保传入任务管理器的参数都是有效值。这种多层验证机制既保证了数据质量，又避免了无效任务对系统资源的浪费。

### 5.2 中间数据处理

任务执行过程中的中间数据主要包括原始采集文本、抓取统计信息和 AI 分析中间结果。原始采集文本是数据抓取阶段的直接产出，存储在 `allRawTexts` 数组中。每条文本记录代表从社交媒体平台获取的一条用户评论或内容描述，包含文本内容和来源信息。在采集过程中，系统会记录每条文本的来源关键词，便于后续分析时追溯原始数据。采集完成后，系统会进行数据清洗，去除空值和重复内容，确保用于 AI 分析的数据质量。

抓取统计信息用于记录数据采集的概况，包括总文本数量、按关键词分布、采集耗时等指标。这些统计信息虽然不直接参与 AI 分析，但在任务进度展示和结果报告中都有重要作用。AI 分析的中间结果主要体现在 Prompt 构建和 API 调用的过程中。`buildAIProductPrompt` 方法将原始文本转换为符合要求的 Prompt 格式，控制输入文本的数量不超过 20 条，避免超出模型的上下文窗口限制。API 调用过程中会产生请求耗时、响应状态等信息，这些数据对于性能监控和问题排查很有价值。

### 5.3 输出数据结构

AI 产品分析模块的输出数据是结构化的产品方案，包含丰富的产品设计信息。输出的 JSON 结构定义在 `AIProductAnalysis` 接口中，涵盖产品名称、类别、目标用户、核心功能列表、AI 能力列表、价值主张、实现难度、市场潜力、技术栈和开发路线图等关键字段。产品名称是一个简短有吸引力的字符串，代表 AI 生成的产品命名建议。产品类别描述产品所属的领域，如 AI 助手、内容生成、数据分析等。目标用户详细描述产品的目标用户群体特征，帮助产品团队明确用户画像。

核心功能列表和 AI 能力列表分别描述产品应该具备的业务功能和底层 AI 技术支持。每个列表包含 2 到 4 个具体条目，确保产品方案既有深度又不过于复杂。价值主张是一句话说明产品为用户创造的核心价值，是产品定位的核心表达。实现难度和市场潜力分别从技术和商业两个维度评估产品，采用 High、Medium、Low 三级分类，便于产品团队决策优先级。技术栈列出实现产品所需的推荐技术组件，如 OpenAI API、LangChain、Vector DB 等。开发路线图将产品开发分解为多个阶段，每个阶段有明确的目标和时间估算。整个输出结构设计得既全面又精炼，既包含战略层面的产品定位，又涵盖战术层面的实施方案。

## 六、API 接口设计

### 6.1 创建分析任务接口

创建分析任务接口的路径为 `POST /api/analyze-ai-product`，采用 RESTful 设计风格，遵循 HTTP 协议的最佳实践。接口的请求方式为 POST，将分析参数放在请求体中传输。请求体采用 JSON 格式，包含以下字段：`keywords`（必填，字符串数组）、`limit`（可选，数值，默认值 50）、`dataSource`（可选，字符串，默认值 'tiktok'）、`locale`（可选，字符串，默认值 'zh'）。请求头需要设置 `Content-Type: application/json`，确保服务端能够正确解析请求体。

接口的响应采用 HTTP 202 Accepted 状态码，表示请求已被接受处理但尚未完成。这种设计符合异步任务模式的特点，即时返回任务标识符，具体的处理结果需要通过后续的查询接口获取。成功的响应体包含 `jobId` 字段，值为新创建任务的唯一标识符。错误响应根据不同的错误类型返回相应的 HTTP 状态码：400 表示请求参数错误，500 表示服务器内部错误。每种错误响应都包含 `error` 字段，提供人类可读的错误描述，便于前端展示和问题排查。

### 6.2 查询任务状态接口

查询任务状态接口的路径为 `GET /api/ai-product-jobs/{jobId}`，路径参数 `jobId` 指定要查询的任务标识符。接口采用 GET 请求方式，符合幂等性设计原则，可以安全地进行多次查询。请求不需要请求体，所有信息都通过 URL 路径传递。这种设计使得接口可以被前端轮询机制安全地反复调用，同时也被缓存代理等中间件友好支持。

接口的响应根据查询结果返回不同的 HTTP 状态码和数据结构。成功查询返回 200 状态码和完整的任务对象，包含任务 ID、状态（processing/completed/failed）、进度描述、关键词列表、数据源、区域设置、开始时间、结果数组（仅完成状态有值）和错误信息（仅失败状态有值）。如果请求缺少任务 ID，接口返回 400 状态码。如果指定的任务不存在，接口返回 404 状态码。服务器内部错误返回 500 状态码。前端根据这些不同的响应状态更新界面显示，提供用户友好的反馈信息。

## 七、扩展与优化建议

### 7.1 功能扩展方向

AI 产品分析模块具备良好的扩展性，可以在多个方向进行功能增强。首先是数据源扩展，除了现有的 TikHub 和 TikTok，可以接入更多社交媒体平台的数据，如 Instagram、Twitter、Reddit 等。每个新平台只需实现对应的数据源服务类，遵循统一的接口规范，即可无缝集成到系统中。其次是分析维度扩展，除了生成 AI 产品方案，可以增加竞品分析、市场趋势预测、用户画像构建等分析功能。这些功能可以复用现有的数据采集和语义处理能力，只是 AI 提示词和分析逻辑有所不同。

另一个重要的扩展方向是分析结果的多样性控制。目前的 AI 分析每次只生成一个产品方案，可以考虑引入多样性和新颖性机制，生成多个不同方向的产品建议供用户选择。此外，可以增加用户反馈机制，允许用户对生成的产品方案进行评价和修正，系统根据用户反馈优化后续的分析结果。协作功能也是值得考虑的扩展方向，支持团队共享分析任务、评论产品建议、协同完善产品方案。这些扩展功能可以进一步提升系统的实用价值，满足更复杂的产品分析场景需求。

### 7.2 性能优化策略

性能优化是提升用户体验和系统吞吐量的重要工作。在任务执行层面，可以引入任务队列和并发控制机制，避免大量并发任务同时执行导致系统资源耗尽。具体可以采用基于优先级的调度策略，高优先级任务优先执行，或者采用公平调度策略，确保每个用户的任务都能得到合理处理。此外，可以实现任务结果缓存机制，对于相同关键词的分析结果在一定时间内复用，减少重复的 AI API 调用。

在前端交互层面，可以优化轮询策略，使用更高效的状态同步机制。目前采用的基本轮询方式可以改进为 WebSocket 长连接，实现真正的实时推送。同时可以增加乐观更新机制，在请求发送后立即更新界面显示为加载状态，如果后续请求失败再回滚状态。AI API 调用层面，可以考虑批量处理多个文本输入，减少 API 调用次数；或者采用流式响应方式，边生成边展示结果，改善用户感知的响应速度。这些优化策略的实施需要综合考虑系统复杂度、维护成本和实际收益的平衡。
